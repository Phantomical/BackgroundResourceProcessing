// SystemHeat integration.
//
// Most of the modules for SystemHeat are pretty straightforward. We don't
// really care about the extra features they have and they behave exactly
// like the stock module they replace in terms of resource processing.

BACKGROUND_CONVERTER:NEEDS[SystemHeat]
{
    name = ModuleSystemHeatConverter
    adapter = BackgroundResourceConverter

    UsePreparedRecipe = false
}

BACKGROUND_CONVERTER:NEEDS[SystemHeat]
{
    name = ModuleSystemHeatHarvester
    adapter = BackgroundResourceHarvester

    UsePreparedRecipe = false
}

BACKGROUND_CONVERTER:NEEDS[SystemHeat]
{
    name = ModuleSystemHeatAsteroidHarvester
    adapter = BackgroundAsteroidDrill

    UsePreparedRecipe = false
    MassResourceName = BRPSpaceObjectMass
}

BACKGROUND_CONVERTER:NEEDS[SystemHeat]
{
    name = ModuleSystemHeatCometHarvester
    adapter = BackgroundCometDrill

    UsePreparedRecipe = false
}

BACKGROUND_CONVERTER:NEEDS[SystemHeat]
{
    name = ModuleSystemHeatFissionReactor
    adapter = SelectFirst

    ActiveCondition = %Enabled

    // For manual control we pre-apply the throttle to all resource rates and
    // then set DumpExcess = True on the EC output so that the reactor always
    // runs at the designated throttle (unless it runs out of resources).
    BACKGROUND_CONVERTER
    {
        condition = %ManualControl
        adapter = BackgroundConstantConverter
        
        InputList = %inputs
        OutputList = %outputs

        LastUpdateField = LastUpdateTime

        OUTPUT_RESOURCE
        {
            condition = %GeneratesElectricity

            ResourceName = ElectricCharge
            // We multiply everything by %CurrentThrottle * 0.01 but we don't
            // want to apply that to electrical generation so we divide in advance.
            Ratio = %ElectricalGeneration.Evaluate(%CurrentThrottle) / (%CurrentThrottle * 0.01)
            DumpExcess = True
            FlowMode = ALL_VESSEL
        }

        MULTIPLIER
        {
            Value = %CurrentThrottle * 0.01
        }
    }

    BACKGROUND_CONVERTER
    {
        adapter = BackgroundConstantConverter

        InputList = %inputs
        OutputList = %outputs

        LastUpdateField = LastUpdateTime

        OUTPUT_RESOURCE
        {
            condition = %GeneratesElectricity

            ResourceName = ElectricCharge
            Ratio = %ElectricalGeneration.Evaluate(100)
            DumpExcess = False
            FlowMode = ALL_VESSEL
        }
    }
}

BACKGROUND_CONVERTER:NEEDS[SystemHeat]
{
    name = ModuleSystemHeatRadiator
    adapter = BackgroundGenericConverter

    ActiveCondition = %IsCooling
}
