// SCANsat integration.
//
// This is pretty straightforward:
// - Convert RESOURCE blocks to INPUT_RESOURCE
// - The SCANsat module has an `scanningNow` property we can use to determine
//   whether it is active.
// - There is really only ever one SCANsat module on a part, but we can filter
//   on the `scanName` field regardless.
//
// For ModuleSCANresourceScanner we just need to use the `activated` field
// instead of the `scanningNow` property.


@PART[*]:HAS[@MODULE[SCANsat]]:FOR[ZZZ-BackgroundResourceProcessing]:NEEDS[SCANsat]
{
    +MODULE[SCANsat],*
    {
        %TargetModule = #$name$

        @name = ModuleBackgroundConditionalConverter
        %Condition = scanningNow

        brpMarker = true

        @RESOURCE,*
        {
            |_ = INPUT_RESOURCE
            %ResourceName = #$name$
            %Ratio = #$rate$

            !name = delete
            !rate = delete
        }
    }

    @MODULE[ModuleBackgroundConditionalConverter]:HAS[#brpMarker[true],#scanName]
    {
        %TargetField = @scanName == %scanName
    }

    @MODULE[ModuleBackgroundConditionalConverter]:HAS[#brpMarker[true]]
    {
        !brpMarker = delete

        // Clean up fields
        !sensorType = delete
        !fov = delete
        !min_alt = delete
        !max_alt = delete
        !best_alt = delete
        // !scanName = delete
        !animationName = delete
        !requireLight = delete
    }
}

@PART[*]:HAS[@MODULE[ModuleSCANresourceScanner]]:FOR[ZZZ-BackgroundResourceProcessing]:NEEDS[SCANsat]
{
    +MODULE[ModuleSCANresourceContainer],*
    {
        %TargetModule = #$name$

        @name = ModuleBackgroundConditionalConverter
        %Condition = activated

        brpMarker = true

        @RESOURCE,*
        {
            |_ = INPUT_RESOURCE
            %ResourceName = #$name$
            %Ratio = #$rate$

            !name = delete
            !rate = delete
        }
    }

    @MODULE[ModuleBackgroundConditionalConverter]:HAS[#brpMarker[true],#scanName]
    {
        %TargetField = @scanName == %scanName
    }

    @MODULE[ModuleBackgroundConditionalConverter]:HAS[#brpMarker[true]]
    {
        !brpMarker = delete

        // Clean up fields
        !sensorType = delete
        !fov = delete
        !min_alt = delete
        !max_alt = delete
        !best_alt = delete
        // !scanName = delete
        !animationName = delete
        !requireLight = delete
    }
}
