// We want to create one ModuleBackgroundResourceConverter for each module
// that derives from BaseConverter.
//
// The way we do this is by creating a copy of the MODULE node and then
// deleting all the fields we don't care about. We do this in two passes
// per module so that the list of deleted fields is only written out in one
// location.
//
// Note that ModuleBackgroundResourceConverter reads the recipe out of the
// BaseConverter instance, so the only fields that are actually used are
// ConverterName and ConvertByMass.

@PART[*]:HAS[@MODULE[ModuleResourceConverter]]:FOR[ZZZ-BackgroundResourceProcessing]
{
    // This adds a brpModuleIndex field with the selected module's index.
    %brpModuleIndexCounter = 0
    @MODULE[ModuleResourceConverter],*
    {
        %brpModuleIndex = #$../brpModuleIndexCounter$
        @../brpModuleIndexCounter += 1
    }

    +MODULE[ModuleResourceConverter],*
    {
        %TargetModule = #$name$
        %TargetIndex = #$brpModuleIndex$

        @name = ModuleBackgroundResourceConverter
        // We keep ConverterName if specified

        %brpModuleBackgroundResourceConverterMarker = true

        // Keep INPUT_RESOURCE, OUTPUT_RESOURCE, REQUIRED_RESOURCE
        // but delete everything else
    }

    // Fudge priorities somewhat by using FillAmount as a proxy
    @MODULE[ModuleBackgroundResourceConverter]:HAS[#brpModuleBackgroundResourceConverterMarker[true],#FillAmount]
    {
        %priority = -5
    }

    @MODULE[ModuleBackgroundResourceConverter]:HAS[#brpModuleBackgroundResourceConverterMarker[true]] {
        !brpModuleBackgroundResourceConverterMarker = delete
        !brpModuleIndex = delete

        // BaseConverter
        // Keep FillAmount
        // Keep TakeAmount
        !GeneratesHeat = delete
        !UseSpecialistBonus = delete
        !UseSpecialistHeatBonus = delete
        !SpecialistBonusBase = delete
        !AutoShutdown = delete
        !DirtyFlag = delete
        !EfficiencyBonus = delete
        !IsActivated = delete
        !StartActionName = delete
        !StopActionName = delete
        !ToggleActionName = delete
        !resourceOutputName = delete
        !AlwaysActive = delete
        !SpecialistEfficiencyFactor = delete
        !SpecialistHeatFactor = delete
        !DefaultShutoffTemp = delete
        !ExperienceEffect = delete
        !status = delete

        !TemperatureModifier,* {}
        !ThermalEfficiency,* {}

        // ModuleResourceConverter
        // Keep ConvertByMass
    }

    @MODULE[ModuleResourceConverter],*
    {
        !brpModuleIndex = delete
    }
}
