// ModuleGenerator is fairly simple. We just need to check the generatorIsActive
// field on the module in order to determine whether it is active.
//
// It only really seems to be used by RTGs and launch clamps (even in mods) so
// this setup here should be simple enough for pretty much all use cases.
//
// TODO: This ignores the efficiency field on the generator. It may be worth
//       building a specialized module to do exactly that.

@PART[*]:HAS[@MODULE[ModuleGenerator]]:FOR[ZZZ-BackgroundResourceProcessing]
{
    %brpModuleIndexCounter = 0
    @MODULE[ModuleGenerator],* {
        %brpModuleIndex = #$../brpModuleIndexCounter$
        @../brpModuleIndexCounter += 1
    }

    +MODULE[ModuleGenerator]:HAS[~isThrottleControlled]
    {
        %TargetModule = #$name$
        %TargetIndex = #$brpModuleIndex$
        @name = ModuleBackgroundConditionalConverter

        %Condition = generatorIsActive
        %brpModuleGeneratorMarker = true

        @RESOURCE {
            |_ = INPUT_RESOURCE
        }

        @INPUT_RESOURCE {
            ResourceName = #$name$
            Ratio        = #$rate$

            !name = delete
            !rate = delete
        }

        @OUTPUT_RESOURCE {
            ResourceName = #$name$
            Ratio        = #$rate$

            !name = delete
            !rate = delete
        }

    }

    // We bump up the priority of generator modules with no inputs.
    //
    // This way the outputs of, e.g., RTGs are used before fuel cells.
    // This matters more when nuclear reactors come into the picture.
    @MODULE[ModuleBackgroundConditionalConverter]:HAS[#brpModuleGeneratorMarker[true],!INPUT_RESOURCE]
    {
        %priority = 10
    }

    @MODULE[ModuleBackgroundConditionalConverter]:HAS[#brpModuleGeneratorMarker[true]]
    {
        !brpModuleGeneratorMarker = delete
        !brpModuleIndex = delete

        !isAlwaysActive = delete
        !isGroundFixture = delete
    }

    @MODULE[ModuleGenerator]
    {
        !brpModuleIndex = delete
    }
}

@PART[*]:HAS[#brpModuleIndexCounter]:FOR[ZZZ-BackgroundResourceProcessing]
{
    // This needs to be in a separate patch as otherwise MM deletes it before
    // it can be used by the inner modules.
    !brpModuleIndexCounter = delete
}
